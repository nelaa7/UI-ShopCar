/*! For license information please see vtp.js.LICENSE.txt */
(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>n});const i=window.microkernel;class n extends HTMLElement{constructor(){super(),this.dropdown=null,this.currentModelId=null,this.kvpsSyncId=void 0,this._onStateUpdate=this._onStateUpdate.bind(this),this._initalizePartnerPatch=this._initalizePartnerPatch.bind(this),this._initalizePartnerPatchService=this._initalizePartnerPatchService.bind(this),this._initalizePartnerPatchService()}connectedCallback(){this._initializeModule()}disconnectedCallback(){document.removeEventListener("PAGE_READY",this._initalizePartnerPatch),document.removeEventListener("LAYER_LOADED",this._initalizePartnerPatch)}_initalizePartnerPatchService(){i.stateRegistry.subscribeToStore("dbadDealerStore",this._onStateUpdate),document.addEventListener("PAGE_READY",this._initalizePartnerPatch),document.addEventListener("LAYER_LOADED",this._initalizePartnerPatch)}_onStateUpdate(t){this.kvpsSyncId=t.kvpsSyncId||void 0,this._initalizePartnerPatch()}_parseData(t){if(t.items){return t.items.filter((t=>t.id.search(/(carline)/)>-1))}}_mergeLists(t,e){const i=new Map;return t.forEach((t=>{const n=e.find((e=>e.id===t.id)),r=n&&n.count?n.count:0;i.set(t.id.split(".")[1],{new:t.count,used:r})})),e.forEach((t=>{const e=t.id.split(".")[1];i.has(e)||i.set(e,{new:0,used:t.count})})),Array.from(i).map((t=>({id:t[0],...t[1]})))}async _fetchData(t){let{partnerId:e,newCarsUrl:i,usedCarsUrl:n}=t;if(window){const t=t=>{const i=new URL(window.location.protocol+t);return i.searchParams.append("svd","!"),i.searchParams.append("filter",`dealer.${e}`),i.href},r=await fetch(t(n)),a=await fetch(t(i)),s=await r.json(),d=await a.json();if(s&&d){const t=this._parseData(d),e=this._parseData(s);if(t&&e){return this._mergeLists(t,e)}return}}}_patch(t){const e=this.querySelectorAll(".nm-vtp__dropdown-links-container [data-modelid]");e&&e.forEach((e=>{const i=e.dataset.modelid,n=t.find((t=>t.id===i)),r=e.querySelector(".nm-vtp__link-new-cars"),a=e.querySelector(".nm-vtp__link-used-cars");if(r){r.querySelector(".nm-vtp__link-count").innerHTML=n?n.new:0}if(a){a.querySelector(".nm-vtp__link-count").innerHTML=n?n.used:0}}))}_getUrls(){return{newCarsUrl:this.dataset.newcarurl&&this.dataset.newcarurl.length>0?this.dataset.newcarurl:void 0,usedCarsUrl:this.dataset.usedcarurl&&this.dataset.usedcarurl.length>0?this.dataset.usedcarurl:void 0}}async _initalizePartnerPatch(){const t=this.kvpsSyncId,{newCarsUrl:e,usedCarsUrl:i}=this._getUrls();if(t&&e&&i){const n=await this._fetchData({partnerId:t,newCarsUrl:e,usedCarsUrl:i});n&&this._patch(n)}}_initializeModule(){const t=this.querySelector(".audi-dropdown-flyout");if(!t)return;this.dropdown=t;const e=this.dropdown.getSelectedItemData();e&&e.id&&(this.currentModelId=e.id),this.handleDropdownSelectionChange=this.handleDropdownSelectionChange.bind(this),this.dropdown.subscribeToFlyout(this.handleDropdownSelectionChange)}handleDropdownSelectionChange(t){t&&t.id&&(this.currentModelId&&this._setModelLinksAndEecVisibilityById(this.currentModelId,!1),this._setModelLinksAndEecVisibilityById(t.id,!0))}_setModelLinksAndEecVisibilityById(t,e){if(!t)return;const i="nm-vtp--active",n=this.querySelector(".nm-vtp__link-container[data-modelid='"+t+"']"),r=this.querySelector(".nm-vtp__eec-container[data-modelid='"+t+"']");e?(n.classList.add(i),r.classList.add(i),this.currentModelId=t):(n.classList.remove(i),r.classList.remove(i))}}void 0===window.customElements.get("audi-vtp")&&window.customElements.define("audi-vtp",n),window.vtp=e})();
//# sourceMappingURL=vtp.js.map