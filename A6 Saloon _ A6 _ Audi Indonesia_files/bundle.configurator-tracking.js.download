/*! For license information please see bundle.configurator-tracking.js.LICENSE.txt */
/* nemo v170.0.0 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("core-tracking-objects"),require("configurator"),require("core-utils")):"function"==typeof define&&define.amd?define("configurator-tracking",["core-tracking-objects","configurator","core-utils"],e):"object"==typeof exports?exports["configurator-tracking"]=e(require("core-tracking-objects"),require("configurator"),require("core-utils")):t["configurator-tracking"]=e(t["core-tracking-objects"],t.configurator,t["core-utils"])}(globalThis,((t,e,r)=>(()=>{"use strict";var a={523:t=>{t.exports=e},525:e=>{e.exports=t},39:t=>{t.exports=r}},n={};function i(t){var e=n[t];if(void 0!==e)return e.exports;var r=n[t]={exports:{}};return a[t](r,r.exports,i),r.exports}i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var c={};return(()=>{i.r(c),i.d(c,{aveStreamReadyTracking:()=>r,cartObjectConfigurator:()=>h,configurationCarstoreTracking:()=>C,configurationChangeTracking:()=>T,pageObjectConfigurator:()=>w,productObjectConfigurator:()=>E});var t=i(525);class e{static _getComponent(){return document.querySelector(".nm-md-ave-container.nm-active")||document.querySelector("#avecanvas")}static _createPayload(t){return{detail:{eventInfo:{eventAction:"non_interaction",eventName:"acc ave stream ready"},attributes:{componentName:t,label:"",currentURL:window.location.href,targetURL:"",clickID:"",elementName:"",value:"",pos:""}}}}static _getComponentName(t){return null!==t.closest('[data-module="inline-rendering"]')?"inline-rendering":"renderingLayer"}constructor(){if(e._instance)return e._instance;e._instance=this,document.addEventListener("ave-stream-ready-tracking",this._dispatchCustomEvent)}_dispatchCustomEvent(){const r=e._getComponent();if(r){const a=e._getComponentName(r),n=e._createPayload(a),i=new CustomEvent(t.CustomEventService.CUSTOM_TRACKING_EVENT,n);document.dispatchEvent(i)}}}const r=new e,a=()=>{let t=!1;const e=document.querySelector(".nm-content");if(e){const r=e.getAttribute("data-type");r&&"nemo"===r&&(t=!0)}return t},n=()=>{let t=!1;const e=document.querySelector(".nm-content");if(e){const r=e.getAttribute("data-template");r&&"home"===r&&(t=!0)}return t},o=t=>{const e=t.id?{productID:t.id}:{},r=t.mbvId?{productMbvId:t.mbvId}:{},a=t.name?{productName:t.name}:{},n=t.mileage?{mileage:t.mileage}:{};return Object.assign({},e,r,a,n)},s=(t,e)=>{return e&&e[t.family]&&(void 0!==(r=t.family.split("."))&&r.length>0)&&t.family.split(".")||[];var r},u=(t,e)=>{const[r=""]=s(t,e),[,a=""]=s(t,e),n=((t,e)=>{return e&&e[t.family]&&(r=e[t.family]).type&&void 0!==r.type&&e[t.family].type||"";var r})(t,e);return{primaryCategory:r,subCategory1:a,productType:n}},d=t=>{const e=t.price?{price:t.price}:{};return Object.assign({},e)},l=(t,e)=>{const r=0!==Object.keys(o(t)).length?{productInfo:o(t)}:{},a=0!==Object.keys(u(t,e)).length?{category:u(t,e)}:{},n=d(t)!=={}?{price:d(t)}:{},i=0!==Object.keys({}).length?{attributes:{}}:{};return Object.assign({},r,a,n,i)};function g(t){return["audicode-input","teaser-audicode","audicode.visualizer","audicode-search","teaser-prstring","user-configuration","configuration-reset"].indexOf(t)>-1}var p=i(523),m=i(39);class f{static get pollTime(){return 2e3}initialize(){this.callBackFunction=this.getTrackingData.bind(this),t.cartService.register(this.callBackFunction)}extractCurrency(t){if(!t)return"";return[/^([\D+.,]+?)[\d\s]+/gi,/[\d\s]+([\D+.,]+)$/gi].reduce(((e,r)=>{if(void 0===e){const e=r.exec(t);if(e&&e.length>1)return e[1]}return e}),void 0)??""}async getTrackingData(){try{return n()||await m.polling.wait(p.dpuApi.isInitialized,f.pollTime),this._getCartObject()}catch(t){return{}}}_getCartObject(){const{nettoBaseRaw:t,nettoOptionsRaw:e,modelRaw:r,optionsRaw:a,rotrRaw:n,totalRaw:i,total:c}=p.dpuApi.getPrices(),o=this._getBasePrice(t,e,r,a),s=this._getTotalPrice(r,a),u=this._getCartTotal(i,n),d=this.extractCurrency(c),l=p.dpuApi.getPriceRateMode();return{cartID:p.dpuApi.getConfigurationId(),price:{basePrice:o,currency:d,priceWithTax:s,cartTotal:u,carlineBasePrice:this._getCarlineBasePrice(),engineBasePrice:r||"",mode:l||"price"},item:this._getCartItems()}}_getBasePrice(t,e,r,a){return t&&0!==t?this._getTotalPrice(t,e):this._getTotalPrice(r,a)}_getTotalPrice(t,e){return t&&e?parseInt(t,10)+parseInt(e,10):""}_getCartTotal(t,e){let r=t||"";return e&&0!==e&&(r=e),r}_getCartItems(){const t=p.dpuApi.getSelectedItems(),e=p.dpuApi.getFamilies();let r=[];for(const a in t)t.hasOwnProperty(a)&&r.push(l(t[a],e));return r}_getCarlineBasePrice(){return SETUPS.get("nemo.CarlineBasePriceRaw")?parseInt(SETUPS.get("nemo.CarlineBasePriceRaw"),10):0}}const h=new f;function v(t){return{productInfo:{productID:t?.id,productName:t?.name,manufacturer:"Audi"},category:{primaryCategory:t?.itemType,subCategory01:"",productType:"car part"},price:{price:t?.priceValue,currency:h.extractCurrency(t?.price)},attributes:{productMbvId:t?.mbvId}}}function y(t,e){if(!t)return[];const r=t[e]?.id;return r&&Object.keys(t).filter((t=>t.split("_in_")[1]===r))||[]}function b(t,e){const r=[];return t?(t.map((a=>{const n=y(e,a),i=n.map((t=>v(e[t])));if(n.length){const a=v(e[t]);r.push({...a,carParts:i})}})),r):[]}function _(t,e,r){const a=p.dpuApi.getItems()||[];let{addedItems:n,removedItems:i}=function(t){const e=t?.detail?.changeEventData?.configurationItems,r=p.dpuApi.getConfiguration()?.items;let a=[],n=[];return r&&e&&(a=r.filter((t=>!e.includes(t)))||[],n=e.filter((t=>!r.includes(t)))||[]),{addedItems:a,removedItems:n}}(t);const c=r;if(c.detail.attributes.relatedProducts={addedItems:{carParts:[],package:[]},removedItems:{carParts:[],package:[]}},c.detail.attributes.currentURL=window&&window.location.href,function(t,e,r,a){const n=b(t,e),i=b(r,e);n.length&&a.detail.attributes.relatedProducts.addedItems.package.push(n),i.length&&a.detail.attributes.relatedProducts.removedItems.package.push(i)}(n,a,i,c),function(t,e,r,a){t.map((t=>{y(e,t).length||r.detail.attributes.relatedProducts.addedItems.carParts.push(v(e[t]))})),a.map((t=>{y(e,t).length||r.detail.attributes.relatedProducts.removedItems.carParts.push(v(e[t]))}))}(n,a,c,i),function(t){const{addedItems:e,removedItems:r}=t.detail.attributes.relatedProducts;return 0!==e.carParts.length||0!==e.package.length||0!==r.carParts.length||0!==r.package.length}(c)){const t=new CustomEvent(e,c);document.dispatchEvent(t)}}class P{static getPayload(){return{detail:{eventInfo:{eventAction:"callback",eventName:"configurator - configuration start"},attributes:{componentName:"",label:"",currentURL:"",targetURL:"",clickID:"",elementName:"",value:"",pos:"",relatedProducts:{addedItems:{carParts:[],package:[]},removedItems:{carParts:[],package:[]}}}}}}constructor(){if(P._instance)return P._instance;P._instance=this,this._dispatchCustomEvent=this._dispatchCustomEvent.bind(this),document.addEventListener("configuration-start-tracking",this._dispatchCustomEvent)}_dispatchCustomEvent(e){const r=e.detail&&e.detail.type?e.detail.type:null;if(this._isValidStartType(r)){_(e,g(r)?"configuration-tracking":t.CustomEventService.CUSTOM_TRACKING_EVENT,P.getPayload())}}_isValidStartType(t){return["carstore","configuration-start"].indexOf(t)>-1||g(t)}}const C=new P,I={detail:{eventInfo:{eventAction:"callback",eventName:"configurator - configuration change"},attributes:{componentName:"",label:"",currentURL:"",targetURL:"",clickID:"",elementName:"",value:"",pos:"",relatedProducts:{addedItems:{carParts:[],package:[]},removedItems:{carParts:[],package:[]}}}}};class k{constructor(){if(k._instance)return k._instance;k._instance=this,this._dispatchCustomEvent=this._dispatchCustomEvent.bind(this),document.addEventListener("configuration-start-tracking",this._dispatchCustomEvent)}_dispatchCustomEvent(t){const e=t.detail&&t.detail.type?t.detail.type:null;this._isValidChangeType(e)&&_(t,"configuration-tracking",I)}_isValidChangeType(t){return["configuration-change"].indexOf(t)>-1}}const T=new k,S=["home"],j=".nm-content";const w=new class{initialize(){this.callBackFunction=this.getTrackingData.bind(this),t.pageService.register(this.callBackFunction)}async getTrackingData(){return a()&&this._isValidPageTemplate()?{attributes:{applicationName:"nemo"}}:{}}_isValidPageTemplate(){let t=!1,e=document.querySelector(j);if(e){const r=e.getAttribute("data-template");t=!(r&&S.indexOf(r)>-1)}return t}};class O{static get pollTime(){return"2000"}static get selectorsWithProductItems(){return{sClassSelectable:".nm-j-configurator-status_11000",sClassSelectableConflict:".nm-j-configurator-status_11100",sClassSelected:".nm-j-configurator-status_11010",sClassSelectedContainedStandard:".nm-j-configurator-status_10011"}}initialize(){this.callBackFunction=this.getTrackingData.bind(this),t.productService.register(this.callBackFunction)}async getTrackingData(){if(!a()&&!this._isConfiguratorPage())return[];try{return n()||await m.polling.wait(p.dpuApi.isInitialized,O.pollTime),this._getProductItemsArray()}catch(t){return[]}}_getProductItemsArray(){const t=this._collectProductItems();return this._collectProductData(t)}_collectProductItems(){return[...document.querySelectorAll(Object.values(O.selectorsWithProductItems).join(", "))]}_collectProductData(t){return t.reduce(((t,e)=>{const r=e.getAttribute("data-configurator-id");if(!r)return t;const a=p.dpuApi.getItem(r);return a?t.concat(l(a)):t}),[])}_getPrice(t){const e=t.price?{price:t.price}:{};return Object.assign({},e)}_getAttributes(){return{}}_isConfiguratorPage(){return!!document.querySelector(".nm-j-configurator-item")}}const E=new O;h.initialize(),w.initialize(),E.initialize()})(),c})()));
//# sourceMappingURL=bundle.configurator-tracking.js.map